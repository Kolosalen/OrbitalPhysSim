<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Орбитальная симуляция — PyScript</title>

  <link rel="stylesheet" href="https://pyscript.net/releases/2024.6.1/core.css" />
  <script defer src="https://pyscript.net/releases/2024.6.1/core.js"></script>

  <style>
    body{font-family:Inter, sans-serif; margin:18px; background:#f7fafc;color:#0f172a}
    .card{background:white;border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(2,6,23,0.06);margin-bottom:16px}
    header{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    .controls{display:flex;gap:12px;flex-wrap:wrap}
    label{font-size:13px;color:#6b7280}
    button{background:#2563eb;color:white;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    button.secondary{background:#e2e8f0;color:#0f172a}
    #output{height:200px;overflow:auto;background:#0b1220;color:#e6eef8;padding:10px;border-radius:8px;font-family:monospace;font-size:13px}
    #plot{min-height:420px}
    .progress{height:12px;background:#e6eef8;border-radius:999px;overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,#2563eb,#7c3aed);width:0%}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>

  <div class="card header">
    <header>
      <h1>Орбитальная симуляция — PyScript</h1>
      <div style="margin-left:auto;color:#6b7280;font-size:13px">Pyodide в браузере</div>
    </header>

    <div class="controls">
      <label>Дней <input id="days" type="number" value="10" min="1" max="365"></label>
      <label>Точек <input id="npoints" type="number" value="2000" min="300" max="20000"></label>
      <label>J2 <input id="j2" type="checkbox" checked></label>
      <label>Rel <input id="rel" type="checkbox" checked></label>

      <button id="run">Запустить</button>
      <button id="stop" class="secondary">Остановить</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Графики</h3>
      <div id="plot"></div>
    </div>

    <div class="card">
      <h3>Вывод</h3>
      <div class="progress"><i id="bar"></i></div>
      <div id="output">Готов к запуску.</div>
    </div>
  </div>

<!-- PyScript config -->
<script type="py-config">
packages = ["numpy", "matplotlib", "scipy"]
</script>

<!-- PYTHON CODE -->
<script type="py">

from js import document
import numpy as np
import math
import matplotlib.pyplot as plt
from scipy.integrate import solve_ivp
from pyscript import display

output = document.getElementById("output")
bar = document.getElementById("bar")

def log(x):
    output.innerHTML += str(x) + "<br>"
    output.scrollTop = output.scrollHeight

def set_progress(p):
    bar.style.width = f"{p:.1f}%"

# --- твой класс физики ---
class RealisticSatelliteSystem:
    def __init__(self, relativistic=True, include_J2=True):
        self.G = 6.67430e-11
        self.c = 299792458.0
        self.c2 = self.c**2
        self.M_earth = 5.9742e24
        self.R_earth = 6378137.0
        self.J2 = 1.08263e-3
        self.mu = self.G * self.M_earth
        self.relativistic = relativistic
        self.include_J2 = include_J2

    def geodesic_acc(self, r, v):
        R = np.linalg.norm(r)
        a = -self.mu * r / R**3
        return a

def rhs(t, y, sys):
    r = np.array([y[0],y[1],y[2]])
    v = np.array([y[3],y[4],y[5]])
    a = sys.geodesic_acc(r,v)
    return [v[0],v[1],v[2],a[0],a[1],a[2]]

_running = False

async def run_all(event=None):
    global _running
    if _running:
        return

    _running = True
    output.innerHTML = "Запуск...<br>"
    set_progress(0)

    days = int(document.getElementById("days").value)
    npoints = int(document.getElementById("npoints").value)
    j2 = document.getElementById("j2").checked
    rel = document.getElementById("rel").checked

    sys = RealisticSatelliteSystem(relativistic=rel, include_J2=j2)
    log("Параметры загружены")

    t_eval = np.linspace(0, days*86400, npoints)
    y0 = [sys.R_earth+400000, 0,0, 0,7700,0]

    log("Интеграция...")
    sol = solve_ivp(lambda t,y: rhs(t,y,sys),
                    (0, days*86400),
                    y0, t_eval=t_eval)

    log("Построение графика...")
    fig, ax = plt.subplots(figsize=(6,4))
    R = np.sqrt(sol.y[0]**2 + sol.y[1]**2 + sol.y[2]**2)
    ax.plot(t_eval/86400, R/1000)
    ax.set_xlabel("Дни")
    ax.set_ylabel("Высота, км")

    display(fig, target="plot")
    log("Готово!")

    _running = False
    set_progress(100)

def stop_all(event=None):
    global _running
    _running = False
    log("Остановлено.")

# привязка кнопок
document.getElementById("run").addEventListener("click", run_all)
document.getElementById("stop").addEventListener("click", stop_all)

</script>

</body>
</html>
